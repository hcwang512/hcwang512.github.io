---
title: "Bitcask intro"
date: 2021-09-10T17:12:04+08:00
draft: false
---

Bitcask 是一个高效的基于哈希表结构的 kv 数据库。它要实现的目标包括

- 高性能的随机读写单个数据
- 支持高吞吐地写入数据
- 能够处理比内存大的数据，并且性能不随着数据量增长而变差
- 好的容灾处理，包括快速恢复和防止丢数据
- 备份和恢复容易
- 代码和数据结构简单
- 高负载下的性能依旧足够好

Bitcask 的设计非常简单，数据通过追加的方式写到文件中，同时在内存中保存 key 对应的位置。这样对于 `PUT` 操作就只需要追加写入到文件中，性能会很好；对于 `GET` 操作需要从内存中找到 offset，再从文件指定位置读取，需要一次磁盘寻址的时间，而且可以通过使用文件系统的 read ahead cache 来加速读取。
因为 `PUT`, `DEL`, `UPDATE` 都是追加写，随着时间的推移，数据量不断膨胀，肯定需要 merge 操作把老数据清除掉。merge 的时候只对已经不更新的文件进行操作，生成新的只包含最新数据的文件。为了加快启动的速度，每一个数据文件都会有一个 hint 文件，里面包含了 key 和对应的元信息，这样 hint 文件会很小。

Bitcask 完美地实现了上面的这些要求。但是 Bitcask 会占用大量的内存，尤其是对于存储小数据的场景来说，内存/磁盘比会比较大。当然这个问题也可以很简单地通过水平分片来解决。

![bitcash 文件](/images/bitcask_dir.png)

![bitcash 数据结构](/images/bitcask_data.png)

![bitcash get操作](/images/bitcask_get.png)
