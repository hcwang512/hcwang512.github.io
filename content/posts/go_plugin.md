---
title: "Go plugin"
date: 2021-09-02T23:34:52+08:00
draft: false
---

golang 是静态编译型语言，在编译时就需要将所有引用的包加载到最终的可执行程序中。go plugin 提供了在运行时动态加载外部功能的能力。go plugin 带来的好处是可以动态加载，可插拔，可独立开发。其典型的使用场景是

- 业务逻辑由多个代码模块组成，这些模块由不同的团队维护。可以独立开发，发布.
- 业务的总体流程是相对固定的，针对不同的业务执行不同的插件。

使用的时候先将 plugin 编译为 so 动态库，在主函数中打开 so 文件，即可查找到 plugin 中的可导出变量和方法。

go plugin 的一个非常严重的缺点在于需要保证 plugin 和主工程的 go 版本，平台，编译参数都一致，否则会有 panic 报错。这个缺陷极大地限制了 go plugin 的使用。

## hashicorp go-plugin

因此 hashicorp 开发了 go-plugin 项目，plugin 是一个独立进程，与主进程通过本地网络 grpc 调用来双向交换数据。因为是进程间通信，而且传输数据是通过 pb 编码的。因此比 go plugin 有很多的好处。

- 不依赖 go 版本，平台，编译参数。
- 因为运行 plugin 在一个独立的进程中，因此 plugin panic 不会影响到主进程
- 支持双向通信
- 支持更多的语言
- 协议支持版本号。可以确保主进程总是适配 plugin 版本
- 支持多语言实现 plugin
- 可以做到平滑热更新

go-plugin 因为涉及到网络通信，数据编解码，因此在性能上带来一定的损耗。一些优化思路包括

- 网络协议优化，支持多路复用
- 合并小请求
- 支持内置 rpc server，减少 cgo 的调用。grpc 为远程调用做了很多二外的封装和处理逻辑。这些对本地网络通信是不需要的。
- 异步发送和接收
- 优化数据编码协议，降低协议解析开销。比如使用 gogoPB
- 零拷贝及重复利用 buffer 等

做了这些优化之后，基本可以做到和 native 代码相当的性能，包括吞吐量和时延。

## cgo

除了 hashicorp 的 go-plugin 之外，我们也可以用 cgo 的方式来调用共享库这种做法可以避免版本和编译参数不一致导致的问题。cgo 在使用会有一些限制，比如对函数签名有限制，不能使用 go struct, array 等；需要把数据在 c 和 go 之间做中转。

## webAssembly

另一个思路是使用 webAssembly 来实现插件的隔离和热更新。主要包含 2 个方面。

- 用 go 作为运行环境执行 webAssembly
- 用 go 开发 webAssembly

目前这 2 个方面都有现成的支持.
