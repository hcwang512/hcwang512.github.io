---
title: "Lru 的改进"
date: 2021-10-26T00:14:04+08:00
draft: false
---

lru 是常用的缓存置换算法，充分地利用了本地性，它假设最长时间没有被使用的数据将来被使用的可能性更低。
但是在实际的系统中，有不少场景并没有很强的本地性，比如数据库连续扫描大片的数据，或者循环读取比缓存容量大的数据。在这些场景下，缓存命中率会变得很低，而且会有大量的数据置换操作，导致性能变差。

lru/k 和 2Q 解决这个问题的思路是将数据区分为热数据和冷数据，在短期内多次读取的数据才是热数据，会保存更长的时间，短期内只读取过一次的数据是冷数据，会被很快置换。热数据和冷数据的置换策略也有不同，热数据用 LRU，冷数据用 FIFO。这种思路很好地适用于连续扫描大片数据的场景。
mysql 使用了类似的思路。它将整个缓存分成占 5/8 的热数据区和 3/8 的冷数据区。当缓存满了之后，首先插入到 3/8 的位置，冷数据去的数据只有在 1s 内被再次使用才会被移入到热数据区。同时对热数据区的数据移动也做了优化，只有热数据区后3/4 的数据被访问到的时候才会移动，这样可以避免热数据频繁移动。

![mysql lru cache pool](/images/mysql_lru.png)
